***************
*** 42,47 ****
  #include "zlib.h"
  #include "ScriptMgr.h"
  #include "Transport.h"
  
  bool MapSessionFilter::Process(WorldPacket* packet)
  {
--- 42,50 ----
  #include "zlib.h"
  #include "ScriptMgr.h"
  #include "Transport.h"
+ //Playerbot mod
+ #include "PlayerbotAI.h"
+ #include "PlayerbotClassAI.h"
  
  bool MapSessionFilter::Process(WorldPacket* packet)
  {
***************
*** 342,348 ****
          ///- If necessary, log the player out
          if (ShouldLogOut(currTime) && !m_playerLoading)
              LogoutPlayer(true);
- 
          ///- Cleanup socket pointer if need
          if (m_Socket && m_Socket->IsClosed())
          {
--- 361,388 ----
          ///- If necessary, log the player out
          if (ShouldLogOut(currTime) && !m_playerLoading)
              LogoutPlayer(true);
+     //Playerbot mod - Process player bot packets
+     //The PlayerbotAI class adds to the packet queue to simulate a real player
+     //since Playerbots are known to the World obj only its master's
+     //WorldSession object we need to process all master's bot's packets.
+         for(PlayerBotMap::const_iterator itr = GetPlayerBotsBegin(); itr != GetPlayerBotsEnd(); ++itr)
+         {
+             Player *const botPlayer = itr->second;
+             WorldSession *const pBotWorldSession = botPlayer->GetSession();
+             if(botPlayer->IsBeingTeleportedFar())
+             {
+               pBotWorldSession->HandleMoveWorldportAckOpcode();
+           } else if(botPlayer->IsInWorld())
+           {
+               WorldPacket *packet;
+               while(pBotWorldSession->_recvQueue.next(packet))
+               {
+                   OpcodeHandler &opHandle = opcodeTable[packet->GetOpcode()];
+                   (pBotWorldSession->*opHandle.handler)(*packet);
+                   delete packet;
+               }
+           }
+         }
          ///- Cleanup socket pointer if need
          if (m_Socket && m_Socket->IsClosed())
          {
***************
*** 503,508 ****
          _player->CleanupsBeforeDelete();
          sLog->outChar("Account: %d (IP: %s) Logout Character:[%s] (GUID: %u)", GetAccountId(), GetRemoteAddress().c_str(), _player->GetName(), _player->GetGUIDLow());
          Map* _map = _player->GetMap();
          _map->RemoveFromMap(_player, true);
          SetPlayer(NULL);                                    // deleted in Remove call
  
--- 562,568 ----
          _player->CleanupsBeforeDelete();
          sLog->outChar("Account: %d (IP: %s) Logout Character:[%s] (GUID: %u)", GetAccountId(), GetRemoteAddress().c_str(), _player->GetName(), _player->GetGUIDLow());
          Map* _map = _player->GetMap();
+         uint32 guid = _player->GetGUIDLow();
          _map->RemoveFromMap(_player, true);
          SetPlayer(NULL);                                    // deleted in Remove call
  
